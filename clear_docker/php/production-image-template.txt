# ------------------------------------------
# üèóÔ∏è Build stage
# ------------------------------------------
FROM php:8.1-fpm-alpine AS build

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –¥–ª—è –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó —Ä–æ–∑—à–∏—Ä–µ–Ω—å, –≤–∫–ª—é—á–Ω–æ –∑ libsodium-dev
RUN apk add --no-cache --virtual .build-deps \
        $PHPIZE_DEPS \
        icu-dev libxml2-dev libzip-dev \
        mariadb-dev rabbitmq-c-dev linux-headers \
        libpng-dev libjpeg-turbo-dev libwebp-dev libxpm-dev freetype-dev \
        libsodium-dev \
    && apk add --no-cache \
        git unzip curl bash zip libsodium

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ PHP-—Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è (–¥–æ–¥–∞–Ω–æ sodium)
RUN docker-php-ext-configure gd \
        --with-freetype \
        --with-jpeg \
        --with-webp \
        --with-xpm \
    && docker-php-ext-install -j$(nproc) \
        pdo_mysql zip intl soap xml opcache gd sodium

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ pecl-–ø–∞–∫–µ—Ç–∏
RUN pecl install redis amqp \
    && docker-php-ext-enable redis amqp sodium

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ Composer (–æ—Å—Ç–∞–Ω–Ω—é –≤–µ—Ä—Å—ñ—é)
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

# –ö–æ–ø—ñ—é—î–º–æ –∫–æ–¥ –ø—Ä–æ—î–∫—Ç—É
WORKDIR /app
COPY . .

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–¥–∞–∫—à–Ω-–∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
RUN composer install --no-dev --optimize-autoloader --no-interaction

# ------------------------------------------
# üöÄ Runtime stage
# ------------------------------------------
FROM php:8.1-fpm-alpine

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏, –≤–∫–ª—é—á–Ω–æ –∑ libsodium
RUN apk add --no-cache \
        bash curl git libpng libjpeg-turbo libwebp libxpm freetype icu libxml2 libzip mariadb-connector-c rabbitmq-c libsodium

# –ö–æ–ø—ñ—é—î–º–æ –∑—ñ–±—Ä–∞–Ω—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Ç–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
COPY --from=build /usr/local/lib/php/extensions /usr/local/lib/php/extensions
COPY --from=build /usr/local/etc/php/conf.d /usr/local/etc/php/conf.d

# –ö–æ–ø—ñ—é—î–º–æ –∫–æ–¥ —ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
WORKDIR /var/www/html
COPY --from=build /app .

# –£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö —Ä–æ–∑—à–∏—Ä–µ–Ω—å
RUN docker-php-ext-enable redis amqp sodium

CMD ["php-fpm"]

